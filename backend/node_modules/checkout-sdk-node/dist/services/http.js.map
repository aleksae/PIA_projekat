{"version":3,"file":"http.js","names":["pjson","require","get","fetch","path","config","auth","http","post","request","idempotencyKey","patch","put","_delete","createAccessToken","body","requestBody","grant_type","client_id","client","client_secret","secret","scope","join","access","host","includes","SANDBOX_ACCESS_URL","LIVE_ACCESS_URL","method","timeout","agent","URLSearchParams","headers","Accept","ok","json","bodyParser","status","text","then","data","JSON","parse","authHeader","isTokenExpired","expires","Date","type","token","token_type","access_token","getTime","expires_in","getRequestHeaders","response","formData","stringify","buildResponse","csv","buildCsvResponse","buildJsonResponse","txt","Buffer","from","getResponseHeaders","Authorization","pragma","version","undefined","REQUEST_ID_HEADER","raw","requestId","API_VERSION_HEADER","rsp","tokenExpiry","currentTimestamp"],"sources":["../../src/services/http.js"],"sourcesContent":["/* eslint-disable no-throw-literal */\r\n\r\nimport {\r\n    API_VERSION_HEADER,\r\n    REQUEST_ID_HEADER,\r\n    SANDBOX_ACCESS_URL,\r\n    LIVE_ACCESS_URL,\r\n} from '../config';\r\n\r\nconst pjson = require('../../package.json');\r\n\r\nexport const get = async (fetch, path, config, auth) => http(fetch, 'get', path, config, auth);\r\n\r\nexport const post = async (fetch, path, config, auth, request, idempotencyKey) =>\r\n    http(fetch, 'post', path, config, auth, request, idempotencyKey);\r\n\r\nexport const patch = async (fetch, path, config, auth, request) =>\r\n    http(fetch, 'patch', path, config, auth, request);\r\n\r\nexport const put = async (fetch, path, config, auth, request) =>\r\n    http(fetch, 'put', path, config, auth, request);\r\n\r\nexport const _delete = async (fetch, path, config, auth) =>\r\n    http(fetch, 'delete', path, config, auth);\r\n\r\nexport const createAccessToken = async (config, fetch, body) => {\r\n    const requestBody = body || {\r\n        grant_type: 'client_credentials',\r\n        client_id: config.client,\r\n        client_secret: config.secret,\r\n        scope: config.scope.join(' '),\r\n    };\r\n\r\n    const access = await fetch(\r\n        config.host.includes('sandbox') ? SANDBOX_ACCESS_URL : LIVE_ACCESS_URL,\r\n        {\r\n            method: 'post',\r\n            timeout: config.timeout,\r\n            agent: config.agent,\r\n            body: new URLSearchParams(requestBody),\r\n            headers: {\r\n                'Content-Type': 'application/x-www-form-urlencoded',\r\n                Accept: 'application/json',\r\n            },\r\n        }\r\n    );\r\n\r\n    if (!access.ok) {\r\n        const json = bodyParser(access);\r\n        throw { status: access.status, json };\r\n    }\r\n\r\n    return access.text().then((text) => {\r\n        const data = text ? JSON.parse(text) : {};\r\n        return {\r\n            status: access.status,\r\n            json: data,\r\n        };\r\n    });\r\n};\r\n\r\n// eslint-disable-next-line consistent-return,default-param-last\r\nconst http = async (fetch, method, path, config, auth, request, idempotencyKey) => {\r\n    let authHeader = null;\r\n\r\n    if (auth) {\r\n        authHeader = auth;\r\n    } else if (config.client) {\r\n        // TODO Refactor OAuth credentials request\r\n\r\n        // For NAS\r\n        // If an access tokens exists and it's not expired re-use it\r\n        if (config.access && !isTokenExpired(config.access.expires, new Date())) {\r\n            authHeader = `${config.access.type} ${config.access.token}`;\r\n        } else {\r\n            const access = await createAccessToken(config, fetch);\r\n            authHeader = `${access.json.token_type} ${access.json.access_token}`;\r\n\r\n            // eslint-disable-next-line no-param-reassign\r\n            config.access = {\r\n                token: access.json.access_token,\r\n                type: access.json.token_type,\r\n                scope: access.json.scope,\r\n                expires: new Date(new Date().getTime() + access.json.expires_in),\r\n            };\r\n        }\r\n    }\r\n\r\n    const headers = getRequestHeaders(config, request, authHeader, idempotencyKey);\r\n\r\n    const response = await fetch(path, {\r\n        method,\r\n        timeout: config.timeout,\r\n        agent: config.agent,\r\n        body: config.formData ? request : JSON.stringify(request),\r\n        headers,\r\n    });\r\n\r\n    if (!response.ok) {\r\n        const json = bodyParser(response);\r\n        throw { status: response.status, json };\r\n    }\r\n\r\n    return buildResponse(config, response);\r\n};\r\n\r\nfunction buildResponse(config, response) {\r\n    if (config.csv) {\r\n        return buildCsvResponse(response);\r\n    }\r\n\r\n    return buildJsonResponse(response);\r\n}\r\n\r\nasync function buildCsvResponse(response) {\r\n    const txt = await response.text();\r\n\r\n    const csv = Buffer.from(txt);\r\n\r\n    return {\r\n        status: response.status,\r\n        csv,\r\n    };\r\n}\r\n\r\nfunction buildJsonResponse(response) {\r\n    return response.text().then((text) => {\r\n        const data = text ? JSON.parse(text) : {};\r\n        const headers = getResponseHeaders(response);\r\n\r\n        return {\r\n            status: response.status,\r\n            json: data,\r\n            headers,\r\n        };\r\n    });\r\n}\r\n\r\nfunction getRequestHeaders(config, request, authHeader, idempotencyKey) {\r\n    let headers;\r\n\r\n    // eslint-disable-next-line prefer-const\r\n    headers = {\r\n        ...config.headers,\r\n        Authorization: authHeader,\r\n        'Cache-Control': 'no-cache',\r\n        pragma: 'no-cache',\r\n        'user-agent': `checkout-sdk-node/${pjson.version}`,\r\n    };\r\n\r\n    if (request && request.headers) {\r\n        headers = { ...headers, ...request.headers };\r\n    }\r\n\r\n    if (!config.formData) {\r\n        headers['Content-Type'] = config.csv ? 'text/csv' : 'application/json';\r\n    }\r\n\r\n    if (idempotencyKey !== undefined) {\r\n        headers['Cko-Idempotency-Key'] = idempotencyKey;\r\n    }\r\n\r\n    return headers;\r\n}\r\n\r\nfunction getResponseHeaders(response) {\r\n    // Return CKO response headers when available\r\n\r\n    if (REQUEST_ID_HEADER in response.headers.raw()) {\r\n        const requestId =\r\n            response.headers.raw()[REQUEST_ID_HEADER] || response.headers.raw()['request-id'];\r\n        const version =\r\n            response.headers.raw()[API_VERSION_HEADER] || response.headers.raw().version;\r\n        return {\r\n            'cko-request-id': requestId ? requestId[0] : '',\r\n            'cko-version': version ? version[0] : '',\r\n        };\r\n    }\r\n\r\n    return {};\r\n}\r\n\r\n// For 'no body' response, replace with empty object\r\nconst bodyParser = (rsp) => rsp.text().then((text) => (text ? JSON.parse(text) : {}));\r\n\r\nconst isTokenExpired = (tokenExpiry, currentTimestamp) => tokenExpiry < currentTimestamp;\r\n\r\nexport default createAccessToken;\r\n"],"mappings":"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"}